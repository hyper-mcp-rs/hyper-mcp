name: Release

on:
  push:
    tags:
      - "v*" # Match tags like v1.0.0, v2.1.3 etc.

env:
  CARGO_TERM_COLOR: always

jobs:
  # 1) Build & push per-arch images, sign each by digest
  build-oci-images:
    name: Build OCI image (${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: amd64
            platform: linux/amd64
          - os: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      packages: write
      id-token: write # needed for keyless signing

    outputs:
      digest_amd64: ${{ steps.meta.outputs.digest_amd64 }}
      digest_arm64: ${{ steps.meta.outputs.digest_arm64 }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (by platform) with BuildKit cache
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          push: true
          platforms: ${{ matrix.platform }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/hyper-mcp:${{ github.ref_name }}-${{ matrix.arch }}
          cache-from: type=gha,scope=hyper-mcp-release-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=hyper-mcp-release-${{ matrix.arch }}

      - name: Resolve and sign arch image by digest
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/${{ github.repository_owner }}/hyper-mcp"
          ARCH="${{ matrix.arch }}"
          DIGEST="${{ steps.build.outputs.digest }}"

          REF="${IMAGE}@${DIGEST}"
          echo "Signing arch image by digest: ${REF}"
          cosign sign --yes "${REF}"

          if [[ "${ARCH}" == "amd64" ]]; then
            echo "digest_amd64=${DIGEST}" >> "$GITHUB_OUTPUT"
          elif [[ "${ARCH}" == "arm64" ]]; then
            echo "digest_arm64=${DIGEST}" >> "$GITHUB_OUTPUT"
          else
            echo "Unknown arch: ${ARCH}" >&2
            exit 1
          fi

          echo "Built ${IMAGE}:${{ github.ref_name }}-${ARCH} -> ${DIGEST}"

  # 2) Create multi-arch manifests, sign manifests by digest, export digests for the GH release body
  create-multiarch-manifests:
    name: Create & sign multi-arch manifests
    needs: build-oci-images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      tag_digest: ${{ steps.digest.outputs.tag_digest }}
      latest_digest: ${{ steps.digest.outputs.latest_digest }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create, push, and sign manifests by digest
        id: digest
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF#refs/tags/}"
          IMAGE="ghcr.io/${{ github.repository_owner }}/hyper-mcp"

          AMD64_DIGEST="${{ needs.build-oci-images.outputs.digest_amd64 }}"
          ARM64_DIGEST="${{ needs.build-oci-images.outputs.digest_arm64 }}"

          if [[ -z "${AMD64_DIGEST}" || -z "${ARM64_DIGEST}" ]]; then
            echo "Missing per-arch digests from build job." >&2
            exit 1
          fi

          # ---------------- Tag manifest ----------------
          echo "Creating multi-arch manifest: ${IMAGE}:${TAG}"
          docker buildx imagetools create \
            -t "${IMAGE}:${TAG}" \
            "${IMAGE}@${AMD64_DIGEST}" \
            "${IMAGE}@${ARM64_DIGEST}"

          TAG_DIGEST="$(docker buildx imagetools inspect "${IMAGE}:${TAG}" | grep -E '^Digest:' | awk '{print $2}')"
          echo "tag_digest=${TAG_DIGEST}" >> "$GITHUB_OUTPUT"

          echo "Signing tag manifest by digest: ${IMAGE}@${TAG_DIGEST}"
          cosign sign --yes "${IMAGE}@${TAG_DIGEST}"

          # ---------------- Latest manifest ----------------
          echo "Creating multi-arch manifest: ${IMAGE}:latest"
          docker buildx imagetools create \
            -t "${IMAGE}:latest" \
            "${IMAGE}@${AMD64_DIGEST}" \
            "${IMAGE}@${ARM64_DIGEST}"

          LATEST_DIGEST="$(
            docker buildx imagetools inspect "${IMAGE}:latest" --format '{{json .Manifest}}' \
              | python3 -c 'import json,sys; print(json.load(sys.stdin)["digest"])'
          )"

          if [[ ! "$LATEST_DIGEST" =~ ^sha256:[0-9a-f]{64}$ ]]; then
            echo "ERROR: Invalid digest: '$LATEST_DIGEST'" >&2
            exit 1
          fi

          echo "latest_digest=${LATEST_DIGEST}" >> "$GITHUB_OUTPUT"

          echo "Signing latest manifest by digest: ${IMAGE}@${LATEST_DIGEST}"
          cosign sign --yes "${IMAGE}@${LATEST_DIGEST}"

          echo "Resolved ${IMAGE}:${TAG}    -> ${TAG_DIGEST}"
          echo "Resolved ${IMAGE}:latest  -> ${LATEST_DIGEST}"

  # 3) Build release binaries (matrix), upload as artifacts (no GH release here)
  build-release-binaries:
    name: Build release binaries (${{ matrix.target }})
    needs: create-multiarch-manifests
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            ext: ""
            pkg: tar
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            ext: ""
            pkg: tar
          - os: macos-latest
            target: aarch64-apple-darwin
            ext: ""
            pkg: tar
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            ext: ".exe"
            pkg: zip

    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install cargo-auditable
        run: cargo install cargo-auditable

      - name: Install target
        run: rustup target add ${{ matrix.target }}

      - name: Build
        run: cargo auditable build --target ${{ matrix.target }} --release

      - name: Package + checksums
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          bin_name="hyper-mcp${{ matrix.ext }}"
          src_path="target/${{ matrix.target }}/release/${bin_name}"

          # Keep the inner filename consistent per target
          out_bin="hyper-mcp-${{ matrix.target }}${{ matrix.ext }}"
          cp "${src_path}" "dist/${out_bin}"

          if [[ "${{ matrix.pkg }}" == "zip" ]]; then
            # windows runner has bsdtar, so this works without extra installs
            (cd dist && zip -q "hyper-mcp-${{ matrix.target }}.zip" "${out_bin}")
            artifact="dist/hyper-mcp-${{ matrix.target }}.zip"
          else
            tar -czf "dist/hyper-mcp-${{ matrix.target }}.tar.gz" -C dist "${out_bin}"
            artifact="dist/hyper-mcp-${{ matrix.target }}.tar.gz"
          fi

          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "${artifact}" > "dist/checksums-${{ matrix.target }}.txt"
          else
            shasum -a 256 "${artifact}" > "dist/checksums-${{ matrix.target }}.txt"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: release-${{ matrix.target }}
          path: |
            dist/hyper-mcp-${{ matrix.target }}.tar.gz
            dist/hyper-mcp-${{ matrix.target }}.zip
            dist/checksums-${{ matrix.target }}.txt

  # 4) Publish GitHub Release once (download artifacts, write body incl digest, upload assets)
  publish-github-release:
    name: Publish GitHub Release
    needs:
      - build-release-binaries
      - create-multiarch-manifests
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: release-*
          path: dist

      - name: Flatten artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          find dist -type f -maxdepth 3 -print -exec cp {} out/ \;

      - name: Write release body (include immutable digest)
        id: notes
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF#refs/tags/}"
          IMAGE="ghcr.io/${{ github.repository_owner }}/hyper-mcp"
          TAG_DIGEST="${{ needs.create-multiarch-manifests.outputs.tag_digest }}"

          cat > release-body.md <<EOF
          Final release for \`${TAG}\`.

          Included:
          - hyper-mcp binaries for Linux & macOS
          - hyper-mcp container image: \`${IMAGE}:${TAG}\`

          âœ… Multi-arch digest (immutable, recommended for pinning):
          - \`${IMAGE}@${TAG_DIGEST}\`

          All container images are signed with Cosign. Verify with:

          \`\`\`bash
          cosign verify \
            --certificate-identity "https://github.com/hyper-mcp-rs/hyper-mcp/.github/workflows/release.yml@refs/tags/${TAG}" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ${IMAGE}@${TAG_DIGEST}
          \`\`\`
          EOF

          echo "body_path=release-body.md" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          preserve_order: true
          body_path: ${{ steps.notes.outputs.body_path }}
          files: |
            out/*
