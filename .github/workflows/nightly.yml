name: Nightly Release

on:
  schedule:
    - cron: "0 0 * * *" # midnight GMT
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # 0) Move/force the "nightly" tag to main and delete the prior GH release.
  prepare-nightly-release:
    name: Prepare nightly tag + delete prior release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set nightly tag to latest main
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main
          git tag -f nightly origin/main
          git push -f origin nightly

      - name: Delete existing nightly release (if any)
        shell: bash
        run: gh release delete nightly --yes || true

  # 1) Build & push per-arch nightly images, sign each by digest, export digests for manifest job.
  build-oci-images:
    name: Build OCI nightly image (${{ matrix.arch }})
    environment: staging
    needs: prepare-nightly-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: amd64
            platform: linux/amd64
          - os: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      packages: write
      id-token: write # keyless cosign
    outputs:
      digest_amd64: ${{ steps.meta.outputs.digest_amd64 }}
      digest_arm64: ${{ steps.meta.outputs.digest_arm64 }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (by platform) with BuildKit cache
        id: build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          push: true
          platforms: ${{ matrix.platform }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/hyper-mcp:nightly-${{ matrix.arch }}
          cache-from: type=gha,scope=hyper-mcp-nightly-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=hyper-mcp-nightly-${{ matrix.arch }}

      - name: Resolve and sign arch image by digest
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/${{ github.repository_owner }}/hyper-mcp"
          ARCH="${{ matrix.arch }}"
          DIGEST="${{ steps.build.outputs.digest }}"

          REF="${IMAGE}@${DIGEST}"
          echo "Signing arch nightly image by digest: ${REF}"
          cosign sign --yes "${REF}"

          if [[ "${ARCH}" == "amd64" ]]; then
            echo "digest_amd64=${DIGEST}" >> "$GITHUB_OUTPUT"
          elif [[ "${ARCH}" == "arm64" ]]; then
            echo "digest_arm64=${DIGEST}" >> "$GITHUB_OUTPUT"
          else
            echo "Unknown arch: ${ARCH}" >&2
            exit 1
          fi

          echo "Built ${IMAGE}:nightly-${ARCH} -> ${DIGEST}"

  # 2) Create multi-arch nightly manifest (tag=nightly), sign manifest by digest, export digest for release notes.
  create-multiarch-manifests:
    name: Create & sign multi-arch nightly manifest
    needs: build-oci-images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      nightly_digest: ${{ steps.digest.outputs.nightly_digest }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create, push, and sign nightly manifest by digest
        id: digest
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/${{ github.repository_owner }}/hyper-mcp"
          AMD64_DIGEST="${{ needs.build-oci-images.outputs.digest_amd64 }}"
          ARM64_DIGEST="${{ needs.build-oci-images.outputs.digest_arm64 }}"

          if [[ -z "${AMD64_DIGEST}" || -z "${ARM64_DIGEST}" ]]; then
            echo "Missing per-arch digests from build job." >&2
            exit 1
          fi

          echo "Creating multi-arch manifest: ${IMAGE}:nightly"
          docker buildx imagetools create \
            -t "${IMAGE}:nightly" \
            "${IMAGE}@${AMD64_DIGEST}" \
            "${IMAGE}@${ARM64_DIGEST}"

          NIGHTLY_DIGEST="$(
            docker buildx imagetools inspect "${IMAGE}:nightly" --format '{{json .Manifest}}' \
              | python3 -c 'import json,sys; print(json.load(sys.stdin)["digest"])'
          )"

          if [[ ! "$NIGHTLY_DIGEST" =~ ^sha256:[0-9a-f]{64}$ ]]; then
            echo "ERROR: Invalid digest: '$NIGHTLY_DIGEST'" >&2
            exit 1
          fi

          echo "nightly_digest=${NIGHTLY_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "Resolved ${IMAGE}:nightly -> ${NIGHTLY_DIGEST}"

          echo "Signing nightly multi-arch manifest by digest: ${IMAGE}@${NIGHTLY_DIGEST}"
          cosign sign --yes "${IMAGE}@${NIGHTLY_DIGEST}"

  # 3) Build binaries (matrix), upload as artifacts.
  build-nightly-binaries:
    name: Build nightly binaries (${{ matrix.target }})
    environment: staging
    needs: prepare-nightly-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            ext: ""
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            ext: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            ext: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            ext: ".exe"
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install cargo-auditable
        run: cargo install cargo-auditable

      - name: Install compilation target
        run: rustup target add ${{ matrix.target }}

      - name: Build
        run: cargo auditable build --target ${{ matrix.target }} --release --locked

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          bin="hyper-mcp${{ matrix.ext }}"
          src="target/${{ matrix.target }}/release/${bin}"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            # Use PowerShell's Compress-Archive? We'll keep it simple with tar if available;
            # but Windows runners have bsdtar via Git. Use zip for compatibility.
            7z a "dist/hyper-mcp-${{ matrix.target }}.zip" "${src}"
            pkg="dist/hyper-mcp-${{ matrix.target }}.zip"
          else
            tar -czf "dist/hyper-mcp-${{ matrix.target }}.tar.gz" -C "target/${{ matrix.target }}/release" "${bin}"
            pkg="dist/hyper-mcp-${{ matrix.target }}.tar.gz"
          fi

          # checksums
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "${pkg}" > "dist/checksums-${{ matrix.target }}.txt"
          else
            shasum -a 256 "${pkg}" > "dist/checksums-${{ matrix.target }}.txt"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: nightly-${{ matrix.target }}
          path: |
            dist/hyper-mcp-${{ matrix.target }}.tar.gz
            dist/hyper-mcp-${{ matrix.target }}.zip
            dist/checksums-${{ matrix.target }}.txt
          if-no-files-found: ignore

  # 4) Create the GitHub nightly release once, attach all artifacts, and include the immutable nightly digest.
  publish-nightly-release:
    name: Publish nightly GitHub Release
    needs:
      - build-nightly-binaries
      - create-multiarch-manifests
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: nightly-*
          path: dist

      - name: Flatten artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          find dist -type f -maxdepth 3 -print -exec cp {} out/ \;

      - name: Write release notes (with immutable digest)
        id: notes
        shell: bash
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/${{ github.repository_owner }}/hyper-mcp"
          NIGHTLY_DIGEST="${{ needs.create-multiarch-manifests.outputs.nightly_digest }}"
          SHA="${GITHUB_SHA}"

          cat > release-body.md <<EOF
          Nightly build from \`main\`.

          Commit:
          - \`${SHA}\`

          Container image (tag):
          - \`${IMAGE}:nightly\`

          âœ… Multi-arch digest (immutable, recommended for pinning):
          - \`${IMAGE}@${NIGHTLY_DIGEST}\`

          All container images are signed with Cosign. Verify the **immutable digest** with:

          \`\`\`bash
          cosign verify \
            --certificate-identity "https://github.com/hyper-mcp-rs/hyper-mcp/.github/workflows/nightly.yml@refs/heads/main" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ${IMAGE}@${NIGHTLY_DIGEST}
          \`\`\`
          EOF

          echo "body_path=release-body.md" >> "$GITHUB_OUTPUT"

      - name: Create nightly release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: nightly
          name: Nightly build
          draft: false
          prerelease: true
          generate_release_notes: true
          preserve_order: true
          body_path: ${{ steps.notes.outputs.body_path }}
          files: |
            out/*
